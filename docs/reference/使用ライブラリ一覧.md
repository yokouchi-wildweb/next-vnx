# 🦞 使用ライブラリガイド

このドキュメントでは、プロジェクトで採用している主要なライブラリと、その役割・採用理由・利用上のポイントをカテゴリ別に整理しています。各セクションを参照し、設計・実装時に適切な選択と使い分けを行ってください。

## フロントエンド基盤

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **Next.js 16.0.3** | App Router をベースとした SSR/SSG・サーバーアクションによるレンダリング最適化 | 公式の推奨構成に従い、Server Component をデフォルトとする。App Router の並列ルート・レイアウト機能を活用し、`fetch` のキャッシュポリシーや `revalidateTag` によるデータ再取得も検討する。 |
| **Tailwind CSS** | ユーティリティクラスによるスタイリング | `cva()` と組み合わせてバリアントを整理し、グローバルスタイルは `src/styles/` に集約する。Tailwind のカスタムテーマは `tailwind.config.ts` ではなく `src/styles/theme.css` で管理。 |
| **@headlessui/react** | UI のアクセシビリティとインタラクション制御 | モーダルやダイアログなどの高度なアクセシビリティ要件を満たす。`Transition` コンポーネントは `framer-motion` との併用も可能。 |
| **shadcn/ui** | デザインシステムのベースとなるコンポーネント集 | CLI による生成後は `components/Shadcn/` へ配置し、直接編集でバリアントを拡張。既存のボタン・フォーム部品を優先的に再利用する。 |
| **react-icons** | アイコンフォント/ベクターアイコン | サイズ・色は Tailwind クラスで統一。不要なアイコンの tree shaking を意識してインポートする。 |

## フォームとバリデーション

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **react-hook-form** | フォーム状態管理と送信制御 | `useForm` に `FormValues` 型を適用し、`Controller` ではなく独自フィールドコンポーネントを基本とする。サーバー通信前に `handleSubmit` でバリデーションを完了させる。 |
| **zod** | スキーマバリデーションと型推論 | ドメイン共通のスキーマは `entities/schema.ts` に定義し、フォーム固有の差分はコンポーネント配下の `formEntities.ts` に切り出す。サーバーサイドのバリデーションでも同一スキーマを再利用する。 |

フォーム構築の詳細な手順は [src/components/Form/README.md](../../src/components/Form/README.md) を参照してください。

## 認証とセキュリティ

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **Firebase Auth** | メールリンクや OAuth を含むマルチチャネル認証 | クライアント／サーバー双方で同一のセッション状態を共有するため、`/api/me` を介して `SWR` で状態を取得する。ID トークンの検証はサーバーサービスで行う。 |
| **jose** | JWT の署名検証・暗号化ユーティリティ | Firebase Admin SDK では扱いづらいカスタムトークンや外部サービスとの OpenID Connect 連携に使用。`import { jwtVerify } from "jose"` などを用いて ID トークン検証を実装し、非同期処理では `Uint8Array` 形式の秘密鍵管理に注意する。 |

## 状態管理

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **zustand** | 軽量なグローバル状態の管理 | `stores/` 配下にストア本体を、`useSiteTheme.ts` のような薄いラッパーフックに分離して副作用を局所化する。永続化が必要な場合はミドルウェアを追加し、SWR と責務が重複しないようにする。 |

## データベースと ORM

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **Neon (PostgreSQL)** | リレーショナルデータ保存 | 接続文字列は `DATABASE_URL` で管理。Drizzle のマイグレーションと併用し、厳密な整合性が必要なドメインを担当。 |
| **Firestore** | ドキュメント指向データ保存 | 高頻度更新やリアルタイムリスニングが必要なドメイン向け。サービスアカウントキーは `MY_SERVICE_ACCOUNT_KEY` に格納し、SSR では Admin SDK 経由でアクセスする。 |
| **drizzle-orm** | Neon 用の型安全なクエリビルダー | スキーマは `entities/drizzle.ts` に配置し、共通 CRUD は `services/server/drizzleBase.ts` を経由する。トランザクションは `db.transaction(async (tx) => ...)` を利用。 |

## API 連携とデータ取得

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **Axios** | HTTP クライアント | クライアントサービス層で `axios.create` を使い、例外は `normalizeHttpError` で `HttpError` に正規化して throw する。リトライ戦略やインターセプターは `src/lib/crud/httpClient.ts` を拡張。 |
| **SWR** | キャッシュを伴うデータ取得 | `useSWR`/`useSWRMutation` をラップしたドメイン固有フックを提供。`mutate` のキー管理と `fallbackData` の設定で SSR データと整合性を保つ。 |

## 日付・ユーティリティ

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **dayjs** | 軽量な日付操作ライブラリ | タイムゾーンやロケールを統一するため、必要なプラグインを `src/lib/dayjs.ts` などで集中管理する。フォーマットは UI コンポーネント内で定義せず、ユーティリティにまとめる。 |
| **uuidv7** | 時系列並び替えが容易な UUID 生成 | データベースの主キーに使用し、連番よりも衝突が少なくソート可能。ブラウザとサーバーの両方で動作する。 |

## 演出・アニメーション

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **@use-gesture/react** | ジェスチャー検知 | ドラッグ・ピンチなどの入力を `framer-motion` と組み合わせる。イベントハンドラはクライアントコンポーネントへ限定。 |
| **framer-motion** | 2D アニメーション・トランジション | ページ遷移やトースト表示など、ユーザー体験の向上に利用。`layoutId` を使ったアニメーションは SSR への影響を考慮する。 |
| **three** / **@react-three/fiber** / **@react-three/drei** | 3D シーン構築と描画補助 | 3D 演出を行う場合は、`Canvas` をクライアントコンポーネントでラップし、ライト・カメラプリセットは `drei` を活用。パフォーマンス最適化のため `Suspense` と `useFrame` の使用範囲を調整する。 |
| **leva** | 3D/演出の調整用コントロールパネル | デバッグ用 UI としてのみ読み込み、本番ビルドでは不要な場合は `dynamic` import で遅延読み込みする。 |
| **xstate / @xstate/react** | 状態遷移のモデリング | 複雑なステートマシンを定義し、UI からは `useMachine` を介して操作する。状態遷移の可視化やテストが必要な際に導入する。 |

## ビルド・開発サポート

| ライブラリ | 主な用途 | 利用上のポイント |
| --- | --- | --- |
| **prettier** | コードフォーマッター | チーム内のコーディングスタイルを統一。Tailwind プラグインと併用してクラス並び順も揃える。 |
| **chart.js / react-chartjs-2** | グラフ描画 | 組み込みの `tree-shaking` を活かすため、必要なチャートタイプのみ個別に import。レスポンシブ対応は `options` の `maintainAspectRatio` を調整。 |

---

ライブラリのバージョン更新や追加時は、本ガイドを更新し README からも参照できるようにしてください。
