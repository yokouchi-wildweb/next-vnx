# 汎用 CRUD サービスの設計方針とメソッドごとの要求型

本ドキュメントでは、Drizzle ORM 版の `createCrudService` を中心に、汎用 CRUD サービスの型パラメーターや各メソッドの挙動を整理します。汎用サービスはドメイン横断の共通土台として設計されており、[層構成の方針](../!must-read/アプリ構築における構成層.md) と整合する形でサーバーサービス層から利用されます。

## 1. 汎用サービスの全体像

- サーバーサービス層の各ドメイン（例: `src/features/sample/services/server/drizzleBase.ts`）では、Drizzle テーブル定義を渡して `createCrudService` を呼び出し、CRUD 操作をまとめたオブジェクトを得ます。
- Drizzle 版サービスの実装は `src/lib/crud/drizzle/index.ts` にまとまっており、戻り値のオブジェクトがすべての CRUD メソッドを提供します。
- Firestore 版も同じインターフェースを持ちますが、本ドキュメントでは Drizzle 版を基準に説明します。

## 2. 型パラメーターと既定値

### 2.1 `TTable`

- 第一型引数 `TTable` には `PgTable` を継承した Drizzle テーブルを指定します。`createCrudService` 内部では `InferSelectModel<TTable>` から `Select` 型を、`TTable` の `id` カラムから ID 列を特定します。

### 2.2 `TCreate` と `DefaultInsert`

- 第二型引数 `TCreate` は「サービスが受け取る作成データ型」です。省略すると `DefaultInsert<TTable>` が既定値として使われます。
- `DefaultInsert<TTable>` は `InferInsertModel<TTable>` から `id`・`createdAt`・`updatedAt` を除外した型であり、Drizzle のテーブル定義（例: `src/features/sample/entities/drizzle.ts`）を基に自動生成される挿入モデルをそのまま流用します。
- したがって `TCreate` を明示しない場合、アップサートを含む CRUD 操作は「テーブル挿入に必要な必須カラムを満たすデータ」を要求します。必要に応じて `createCrudService<MyTable, CustomCreate>()` のように第二型引数を指定し、作成用型を差し替えることも可能です。

### 2.3 オプションと衝突解決

- オプション `CreateCrudServiceOptions<TCreate>` は ID の採番方法や検索・ソートの既定値に加え、`defaultUpsertConflictFields` を指定できます。型パラメーター `TCreate` のキーからしか選べないため、アップサート時の衝突検知対象は作成用型と整合している必要があります。
- `upsert` 実行時に `conflictFields` を指定しなければ、オプションで与えた `defaultUpsertConflictFields`、それも無ければ `id` カラムが衝突検知対象になります。

## 3. メソッドごとの挙動と期待する型

| メソッド | 受け取る型 | 主な処理 | 備考 |
| --- | --- | --- | --- |
| `create(data)` | `Insert`（= `TCreate`） | スキーマでパースしたデータに ID やタイムスタンプを補完し、`undefined` を含まない形で挿入します。 | ID の扱いは `serviceOptions.idType` で制御します。 |
| `list()` | なし | 既定のソート条件を適用して全件取得します。 | `defaultOrderBy` があれば適用。 |
| `get(id)` | `string` | 単一 ID のレコードを取得します。 | 見つからなければ `undefined`。 |
| `update(id, data)` | `Partial<Insert>` | スキーマでパースした値から `undefined` を除いたものだけを更新対象として送ります。 | 部分更新専用。 |
| `remove(id)` | `string` | ID を条件に削除します。 | 戻り値なし。 |
| `search(params)` | `SearchParams` | 条件組み立て・あいまい検索・ページングを行います。 | `defaultSearchFields` を活用。 |
| `query(baseQuery, options, countQuery?)` | Drizzle クエリ | 任意のクエリにページングを適用します。 | 高度な検索向け。 |
| `bulkDeleteByIds(ids)` | `string[]` | 複数 ID を `inArray` で削除します。 | |
| `bulkDeleteByQuery(where)` | `WhereExpr` | where 条件に一致するレコードを一括削除します。 | Firestore 版は OR 条件をサポートしません。 |
| `upsert(data, options?)` | `Insert & { id?: string }` | `create` と同様にスキーマでパースした値を用意し、`undefined` を含まないデータを `onConflictDoUpdate` の `set` に渡します。`id` は `set` から除去されます。 | 衝突対象は `resolveConflictTarget` で決定。 |

### 3.1 部分更新を行いたい場合

- `upsert` は `Insert` と同じ型を要求し、`onConflictDoUpdate` へ渡す `set` も同じ構造であるため、型レベルでは「作成可能なデータ」を求めます。そのため各フィールドをオプショナルにした部分更新用スキーマを直接 `upsert` に渡すことはできません。
- 既存レコードの部分更新だけを行いたい場合は `update(id, Partial<Insert>)` を利用し、`undefined` を取り除いた入力を必要に応じてスキーマパースで整形します。

### 3.2 `upsert` の挙動詳細

1. `Insert` 型データをコピーし、スキーマパーサー（`parseUpsert` または `parseCreate`）の結果を利用します。
2. ID 採番ポリシーに従って `id` を調整し、`undefined` を取り除きます。
3. `updateData` として `id` を除いた値を `set` に渡し、`onConflictDoUpdate` を実行します。

この挙動により、指定カラムのみ更新されますが、型レベルでは `Insert` の必須プロパティを満たす必要がある点に注意してください。

## 4. Drizzle テーブル定義との連携

- 各ドメインの `entities/drizzle.ts` で `pgTable` を用いてテーブル構造を定義すると、Drizzle が `InferInsertModel` / `InferSelectModel` を生成します。`DefaultInsert` がこれらから `id`・タイムスタンプ列を除外した型であり、`drizzle.ts` の設計変更がそのまま CRUD サービスに反映されます。
- 例えばサンプルドメインでは、`src/features/sample/entities/drizzle.ts` に定義した `name` や `status` が必須カラムであり、更新用に各フィールドをオプショナルへ緩和したスキーマを利用する場合でも、`upsert` に渡すには `TCreate` 側で必須プロパティを満たすよう設計する必要があります。

## 5. 設計上の留意点

1. **層ごとの責務** – 汎用サービスはサーバーサービス層内でのみ利用し、API ルートや UI 層から直接呼び出さないことで責務分離を保ちます。これは構成層ガイドラインにも沿っています。
2. **部分更新の導線** – `update` は `Partial<Insert>` を許容するため、更新専用スキーマとの相性が良く、アップサートで部分更新を行う必要はありません。
3. **アップサートの型拡張** – 新規挿入と部分更新を同一メソッドで扱いたい場合は、`createCrudService` の第 2 型引数をカスタム型で明示し、必須カラムの埋め合わせ責務を呼び出し側で担う必要があります。
4. **エラーハンドリング** – 汎用サービス自体はエラー正規化を行わないため、サーバーサービス層で `DomainError` を投げる設計やクライアント側の `HttpError` 整形ポリシーを合わせて適用してください。

## 6. まとめ

- `createCrudService` の `TCreate` は「サービス作成時に受け取るデータ型」であり、既定では Drizzle の `InferInsertModel` 由来の型を採用します。
- `upsert` は `Insert` 型を要求しつつ、衝突対象や更新カラムを内部で制御します。部分的な更新を行う場合は `update` を利用するのが基本方針です。
- テーブル定義を変更すると `DefaultInsert`／`Select` が連動して変わるため、ドメインエンティティ側のスキーマとあわせて、型の責務を明確に保つことが重要です。
