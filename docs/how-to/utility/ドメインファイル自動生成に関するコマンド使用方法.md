# ドメインファイル自動生成に関するコマンド使用方法

`scripts/domain-config/` 配下の CLI は、`features/_template` をベースにしたドメイン雛形生成やレジストリ更新を自動化する仕組みです。`package.json` には下記の npm script が登録されているため、`npm run <script> -- <Domain>` で利用します。

| コマンド | 主な用途 |
| --- | --- |
| `npm run dc:init` | `domain.json` を対話的に新規作成する。 |
| `npm run dc:generate -- <Domain>` | 指定ドメインの一式を生成・再生成する。 |
| `npm run dc:generate:all` | `domain.json` を持つすべてのドメインを一括再生成する。 |
| `npm run dc:delete -- <Domain>` | 生成物とレジストリ登録を削除する。 |

## 共通の注意点
- コマンドはリポジトリのルートで実行する。
- 既存ファイルがあっても**上書き**されるため、Git で差分を追える状態にしておく。
- Firestore/Neon など DB エンジンの設定は `domain.json` の `dbEngine` に従う。
- 生成結果は MediaInputSuite / DomainFieldRenderer を前提にしているため、旧 `ImageUploaderField` や `_partial` テンプレートは利用しない。

---

## `npm run dc:init`

新しいドメインの `domain.json` を作成するコマンドです。対話的に以下の項目を順に入力します。

1. 単数形／複数形、管理画面ラベル
2. 使用 DB エンジンと ID 型、タイムスタンプの有無
3. `belongsTo` / `belongsToMany` 等のリレーション
4. フィールド定義（名前・型・フォーム入力種別・optionsなど）
5. 管理画面テーブルで表示する列、初期ソート設定
6. 生成対象カテゴリ（entities/components/hooks 等）
7. MediaUploader を選択した場合は追加で以下も回答します
   - アップロード先パス
   - MIME/拡張子プリセット（画像のみ / 動画のみ / 両方 / 制限なし）
   - 最大ファイルサイズ（MB単位、デフォルト100MB）

回答後に `src/features/<domain>/domain.json` が作成され、続けて生成するかどうかの確認が表示されます。`Yes` を選ぶと `dc:generate` が即実行され、`No` の場合は設定だけ保存されます。

> 補足: MediaUploader 以外のフィールドも DomainFieldRenderer を通じて描画されるため、`formInput` の種類は `TextInput` / `Select` / `MultiSelect` など既存の汎用入力コンポーネントに合わせて選択してください。

---

## `npm run dc:generate -- <Domain>`

既存の `domain.json` を基にドメイン一式を生成・再生成します。初期生成のほか、フィールド追加やテンプレート更新後にも利用します。

### 実行手順
1. `npm run dc:generate -- Sample` のようにドメイン名を渡して実行。
2. 生成モードを選択。
   - `domain.json の設定どおりに生成`（デフォルト）
   - `生成カテゴリを手動で選択`（一時的な出力制御。保存可）
   - `すべてのファイルを生成`
3. 「既存ファイルは上書きされます。実行しますか？」で `Yes` を選択。
4. 選ばれたカテゴリごとにジェネレーターが順番に走る。

### 生成される主なファイル
- `components/` … Admin セクションコンテナ、`Create__Domain__Form` / `Edit__Domain__Form`、`__Domain__Form`、`__Domain__Fields`
  - `__Domain__Fields` は DomainFieldRenderer を使い、`domain.json` の `fields` と `relations` を 1 つのレンダラーにまとめる
  - MediaUploader フィールドがある場合でも、専用フックは不要で `useMediaUploaderField` が内部で使われる
- `hooks/` … CRUD フック一式 (`useCreate__Domain__` など)
- `services/client` / `services/server` … axios クライアントとサーバーサービス
- `entities/` … Zod スキーマ、Drizzle テーブル、モデル定義
- `constants/` / `types/field.ts` … options を持つフィールドがある場合のみ
- `app/admin/(protected)/<domain>/` … 一覧／新規／編集ページ
- `registry/` … `schemaRegistry.ts` / `serviceRegistry.ts` / `adminDataMenu.ts` へ追記

### 旧テンプレートとの差分
- `_partial` を使ったコンポーネント生成は廃止され、すべて DomainFieldRenderer + MediaInputSuite を基準に出力されます。
- 旧 `FileUrlInput` / `ImageUploaderField` は生成結果に含まれません。MediaUploader 系フィールドは `MediaFieldItem` が自動的に組み込まれ、アップロード中の commit/reset もフォーム側で統一的に扱えます。

### エラーになりがちなケース
- `domain.json` が破損している／ JSON が整形されていない → CLI で入力や保存をやり直す。
- テンプレート変更途中で存在しないパスを参照している → `npm run build --webpack` 等で検証しながら再度 `dc:generate` を実行。

---

## `npm run dc:generate:all`

`domain.json` を持つ全ドメインに対して `dc:generate (mode=config)` を自動で実行します。テンプレート更新後にまとめて再出力したい場合に使用します。

注意点：処理中は全ドメインのファイルが上書きされるため、Git で差分を確認しつつ単独作業のタイミングで実行してください。途中で失敗したドメインがあれば個別に `dc:generate` をやり直します。

---

## `npm run dc:delete -- <Domain>`

指定ドメインの生成物を削除します。`domain.json` を残すか、関連ディレクトリをまとめて削除するか選択できます。レジストリ（`adminDataMenu.ts` 等）からの削除も自動で行われます。

削除時は対象ドメイン名を `snake_case` で入力して確認する手順があるため、誤削除を防げます。実行後は `git status` で差分を確認してください。

---

## トラブルシュート / よくある質問
- **MediaUploader の質問が出ない** … `formInput` を `mediaUploader` に設定したフィールドのみ追加質問が出ます。
- **生成後のフォームに独自フィールドを挿入したい** … `__Domain__Fields.tsx` を直接編集するか、`DomainFieldRenderer` の `fields` 引数へ追加フィールド設定を渡してください。
- **MediaUploader の commit/reset をカスタマイズしたい** … 生成された `__Domain__Form.tsx` で `onMediaStateChange` を受け取り、`DomainMediaState` を使って制御できます。
- **components/_partial が見つからない** … 本バージョンでは `_partial` は廃止済みのため参照不要です。テンプレートはすべて `features/_template/components/common` 直下で完結します。

テンプレートや CLI を更新した際は、このドキュメントを適宜メンテナンスしてチーム全体の共通理解を保ってください。差分が多くなるため、再生成の前後で `git status` を確認する習慣をつけておくと安全です。
