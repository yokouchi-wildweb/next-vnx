# ドメインファイル自動生成に関するコマンド使用方法

`scripts/domain-config/` 配下の CLI は、`features/_template` を起点にしたドメイン雛形生成やレジストリ更新を一括で行うための仕組みです。`package.json` では下記の npm script がエイリアスとして登録されており、`npm run <script名> -- <ドメイン名>` の形で呼び出します（ドメイン名が不要なコマンドもあります）。

| コマンド | 主な用途 |
| --- | --- |
| `npm run dc:init` | `domain.json` を新規作成する。初回設定を対話形式で入力。 |
| `npm run dc:generate -- <Domain>` | 指定ドメインのファイルを生成・再生成する。 |
| `npm run dc:generate:all` | `domain.json` を持つ全ドメインの生成を一括でやり直す。 |
| `npm run dc:delete -- <Domain>` | 指定ドメインの生成物とレジストリの登録を削除する。 |

以降ではそれぞれのコマンドの具体的なフローと注意点をまとめます。

---

## 共通の事前準備

- ルートディレクトリ（`next-starter` 直下）でコマンドを実行する。
- Node.js 20 系を使用すること（プロジェクト全体の要件）。
- 既存ファイルがある場合でも**上書きされる**ため、Git の差分を確認できる状態で実行する。
- Firestore / Neon など DB エンジンの選択は `domain.json` の `dbEngine` で制御される。再生成でも同じ設定が使われる。

---

## `npm run dc:init`

### 目的
- 新規ドメインの `domain.json` を作成し、生成対象のカテゴリ（エンティティ・サービスなど）を事前に登録する。

### 実行手順
1. ルートで `npm run dc:init` を実行する。
2. 下記のような質問に順番に回答する。
   - ドメインの単数形/複数形・管理画面表示名
   - 使用する DB エンジン（Neon か Firestore）
   - ID の型、タイムスタンプ、ソートキーなど基本情報
   - hasOne/hasMany/belongsToMany などのリレーション
   - 必須フィールド・入力 UI・選択肢（options）などのフィールド定義
   - 管理画面のテーブル表示やCRUD画面構成
   - 自動生成するカテゴリ（エンティティ/コンポーネント/フック/サービス/Enum定数/レジストリなど）
3. `src/features/<domain>/domain.json` が保存される。
4. 続けて「今すぐファイルを生成しますか?」と確認される。`Yes` を選ぶと `dc:generate` と同じ処理が続き、`No` の場合は設定だけが残る。

### 補足
- `domain.json` は CLI が再フォーマットするため **手動編集後は必ず JSON として整形**した状態で保存する。
- 既存フォルダが存在していても初期化できるが、後続の `dc:generate` で上書きされることに注意。

---

## `npm run dc:generate -- <Domain>`

### 目的
- `domain.json` の設定を基にドメイン一式を生成・再生成する。
- テンプレート更新後やフィールド追加後の再出力に利用する。

### ドメイン名の指定
- `npm run dc:generate -- Sample` のように `--` の後へ**パスカルケース or camelCase**のドメイン名を渡す。
- `src/features/<domain>/domain.json` が見つからない場合はエラーで終了するため、事前に `dc:init` か手動での `domain.json` 作成が必要。

### 実行フロー
1. 生成モードの選択
   - `domain.json の設定に基づいて生成`（デフォルト）
   - `生成カテゴリを手動で選択`（その場でエンティティ/サービス/フィールド定数などを選ぶ。保存するかどうかも選択可）
   - `すべてのファイルを生成`
2. 上書き確認
   - 「既存の関係ファイルはすべて上書きされます。生成を実行しますか？」で `Yes` を選ぶと処理が進む。
3. カテゴリごとの生成
   - `components/index.mjs`（セクションコンテナ・共通フォーム）
   - `hooks/generate-hooks.mjs`
   - `generate-client-service.mjs`
   - `generate-server-service.mjs`
   - `fields/index.mjs`（`options` を持つフィールドがある場合のみ）
   - `admin-routes/index.mjs`（`src/app/admin/(protected)/<domain>` 配下）
   - `entities/index.mjs`
   - `registry/index.mjs`（`schemaRegistry.ts` / `serviceRegistry.ts` / `adminDataMenu.ts` への追記）

生成後は差分を確認し、必要に応じてコードの微調整やマイグレーション (`db:generate` / `db:push`) を実行する。

### よくあるエラー
- `設定ファイルが見つかりません`: `src/features/<domain>/domain.json` の存在・ファイル名を確認する。
- `node:internal/errors`: 生成途中で例外が出た場合はテンプレート更新中のファイルパスがズレていないか確認し、再実行する。

---

## `npm run dc:generate:all`

### 目的
- `domain.json` を持つすべてのドメインに対して `dc:generate`（モード:config）を自動実行する。
- テンプレート更新後に一括で再生成したい場合、あるいは `domain.json` の `generateFiles` を信用したい場合に利用する。

### 実行フロー
1. `src/features/*/domain.json` を探索し、対象一覧を表示する。
2. 「すべてのドメインの生成を実行しますか？」で `Yes` を選ぶと処理が進む。
3. 各ドメインに対し `shouldGenerate: true` 固定・手動選択なしで `dc:generate` を順次呼び出す。

### 注意点
- 一括で書き換えるため、コミット前に実行中は他メンバーが作業していないことを確認する。
- 各ドメインで `domain.json` が最新状態であることが前提。途中でエラーが起きた場合は該当ドメインのみ個別に `dc:generate` を再実行する。

---

## `npm run dc:delete -- <Domain>`

### 目的
- 生成済みドメインを安全に削除し、関連レジストリからの参照もまとめて除去する。

### 実行フロー
1. `npm run dc:delete -- Sample` のように対象ドメインを指定して実行する。
2. `snake_case` でのドメイン名入力を求められ、**一致しないと削除が実行されない**。
3. 関連フォルダの確認
   - `src/features/<domain>` と `src/app/admin/(protected)/...` の候補を自動抽出。
   - `src/app` 配下に残った派生ディレクトリがある場合はチェックボックスで追加削除先を選べる。
4. `domain.json` を残すかどうかを選択（残した場合はファイル以外を削除）。
5. 最終確認に `Yes` を選ぶと削除が実行され、以下の処理が走る。
   - 選択したディレクトリの削除
   - `src/registry/adminDataMenu.ts` から該当メニューの `href` を削除
   - `src/registry/schemaRegistry.ts` からエンティティの `export *` を削除
   - `src/registry/serviceRegistry.ts` からサービス import と `registry` の登録を削除
6. 「削除が完了しました。」と表示されれば終了。

### 注意点
- Git で差分を確認しながら進める。誤って削除した場合は `git checkout -- <path>` ではなく `git restore` などで復元する。
- 途中でキャンセルした場合も `domain.json` は残るが、部分的に削除されたフォルダは手動で整理する。

---

## 補足・トラブルシュート

- **ドメイン名の表記ゆれ**: CLI 側で蛇腹ケース/パスカルケースを補正するが、`dc:generate`/`dc:delete` では基本的に `domain.json` の `singular` に合わせたパスカルケースを渡すのが安全。
- **生成カテゴリの再設定**: `dc:generate` で手動モードを選び「domain.json に保存」を `Yes` にすると、`generateFiles` が更新され、次回以降の `config` モードでも反映される。
- **Enum 定数の再出力**: `fields` に `options` を追加した後は、`dc:generate -- <Domain>` を再実行して `constants/field.ts` / `types/field.ts` を作り直す。
- **Drizzle の再マイグレーション**: `dc:generate` で `entities/drizzle.ts` が更新された場合は必ず `npm run db:generate` → `npm run db:push` を行い、Neon 側を同期させる。

これらのコマンドを適切に使い分けることで、ドメインの追加・修正・削除を安全に自動化できます。実行前後で必ず差分を確認し、想定外の変更が入っていないかチェックしてください。
