# 汎用コンポーネントで構築するフォーム実装ガイド

このドキュメントでは、`components/Form` 以下に用意されている汎用コンポーネントを利用して、ドメイン固有のフォームを最短で組み立てる手順をまとめます。最新の `domain-config` 生成テンプレートは `DomainFieldRenderer` + MediaInputSuite (`MediaInput` / `MediaUploader`) を前提としているため、本ガイドも同じ構成で説明します。

## 1. 主要コンポーネントの役割

| レイヤー | 役割 | 備考 |
| --- | --- | --- |
| `AppForm` | `react-hook-form` の `FormProvider` と `<form>` を統合したラッパー | `pending`、`disableWhilePending` などで送信中制御が可能 |
| `FormFieldItem` | `Controller` を内包し、ラベル + 入力カラム + エラーメッセージをまとめる | すべての入力コンポーネントへ `field` を受け渡す役目 |
| 入力コンポーネント | `TextInput`、`SelectInput`、`MediaInput` / `MediaUploader` など | `field` を渡すだけで利用可。バリデーションやスタイルが統一される |
| `DomainFieldRenderer` | `domain.json` の `fields` とリレーション定義をまとめてレンダリング | MediaUploader を含む場合でもハンドラは自動で付与される |

## 2. フォーム全体のパターン

生成済みテンプレート（`Create__Domain__Form` / `Edit__Domain__Form`）は以下の流れに沿って実装されています。手作業でフォームを作る場合も同じパターンを踏襲すると保守しやすくなります。

1. `useForm` で `UseFormReturn<T>` を作成し、`AppForm` に渡す。
2. `__Domain__Fields` のようなフィールド集合コンポーネントを用意し、`methods` を渡して `DomainFieldRenderer` を呼ぶ。
3. `DomainFieldRenderer` は `domainJsonFields`（= `domain.json` の `fields`）と `fields` プロパティ（リレーション等の追加フィールド）を受け取り、`FormFieldItem` を列挙して描画する。
4. MediaUploader を含む場合、`DomainFieldRenderer` が `onMediaStateChange` 経由で `DomainMediaState` をフォーム側に通知するため、フォーム本体はアップロード中のボタン無効化・commit/reset をまとめて制御できる。
5. 送信ハンドラ内でサーバー処理が成功したら `mediaState?.commitAll()` を呼び、キャンセル時は `mediaState?.resetAll()` を呼ぶ。

> 旧構成（`ImageUploaderField` + `_partial`）は廃止済みです。MediaInputSuite を直接利用してください。

## 3. `DomainFieldRenderer` の使い方

`DomainFieldRenderer` は `domain-json` のフィールドを `FormFieldItem` に変換し、必要に応じて追加フィールドを `fields` プロパティから合成します。主な props は以下の通りです。

- `methods`: `useForm` で作成した `UseFormReturn<T>`
- `control`: `methods.control` をそのまま渡す（省略時も `methods` から取得）
- `domainJsonFields`: `domain.json` の `fields` 単純配列。基本は `domainConfig.fields ?? []` を指定
- `fields`: `DomainFieldRenderConfig[]`。リレーション等の追加フィールドを `useMemo` で構築して渡す
- `onMediaStateChange`: MediaUploader フィールドが存在する場合、アップロード中状態や commit/reset 関数を通知するコールバック

### 追加フィールドの例
```tsx
const relationFieldConfigs = useMemo<DomainFieldRenderConfig<FormValues, FieldPath<FormValues>>[]>(
  () => [
    {
      type: "select",
      name: "category_id" as FieldPath<FormValues>,
      label: "カテゴリ",
      options: categoryOptions,
    },
    {
      type: "checkGroup",
      name: "tag_ids" as FieldPath<FormValues>,
      label: "タグ",
      options: tagOptions,
    },
  ],
  [categoryOptions, tagOptions],
);
```

## 4. MediaInputSuite の活用

### MediaInput（ファイルをそのままフォーム送信する場合）
- `MediaInput` / `ManualMediaInput` はファイルオブジェクトをフォーム値として保持します。
- 画像・動画・不明ファイルに応じて自動プレビューを行い、`onMetadataChange` でファイルメタ情報を呼び出し側へ渡します。
- フォーム送信時にファイルそのものを API へ渡したい場合に利用します。

### MediaUploader（アップロードして URL を保持する場合）
- `MediaUploader` / `ControlledMediaUploader` は Firebase Storage などへアップロードし、確定した URL をフォーム値として持ちます。
- `useMediaUploaderField`（`DomainFieldRenderer` 内部で利用）により、アップロード進捗・キャンセル・commit/reset を一元管理します。
- `DomainMediaState` をフォーム本体で受け取り、送信中と同様にボタンを無効化すると UX を統一できます。

### フォームからの制御例
```tsx
const [mediaState, setMediaState] = useState<DomainMediaState | null>(null);

const handleSubmit = async (data: FormValues) => {
  await onSubmitAction(data);
  await mediaState?.commitAll();
};

const handleCancel = async () => {
  await mediaState?.resetAll();
  onCancel?.();
};

<DomainFieldRenderer
  methods={methods}
  fields={relationFieldConfigs}
  domainJsonFields={domainConfig.fields ?? []}
  onMediaStateChange={setMediaState}
/>
```

## 5. 実装ステップまとめ

1. **フォーム値の型を定義し、`useForm` で初期化する。**
2. **フィールド集合コンポーネント（例: `SampleFields`）を用意し、`DomainFieldRenderer` を呼ぶ。**
3. **フォーム本体（例: `SampleForm`）で `AppForm` をラップし、送信/キャンセル時に `mediaState` を活用して commit/reset を行う。**
4. **セクションコンテナ（例: `AdminSampleCreate`）でフォームを読み込み、`submitLabel` や `redirectPath` を渡す。**

## 6. Tips / よくある質問

- **DomainFieldRenderer 以外のフィールドを手動で描画したい** → `fields` に追加する / `DomainFieldRenderer` の前後に個別の `FormFieldItem` を描画するなど柔軟に構成できます。
- **MediaUploader のアップロード先を動的に切り替えたい** → `uploadPath` を props から渡せるようにし、`domain-config` 生成物を薄くラップしてください。
- **複数の MediaInput / MediaUploader を同一フォームで使えるか** → 可能。`DomainFieldRenderer` がフィールド名ごとにハンドルを管理し、`DomainMediaState` をまとめて提供します。
- **旧 `FileUrlInput` / `_partial` を参照しているコードはどうするか** → すべて MediaInputSuite + `DomainFieldRenderer` へ置き換えるのが前提です。生成テンプレートもこの構成で出力されます。

このガイドラインに沿って実装することで、各ドメインのフォームを短時間で統一された UI/UX にまとめることができます。生成テンプレートをカスタマイズする場合も、`DomainFieldRenderer` と MediaInputSuite を中心に構成を組み立ててください。
