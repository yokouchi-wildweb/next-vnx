# 新規ドメイン追加ガイド

アプリに新しいドメインを追加するときの基本手順です。現在の `sample` ドメイン構成を基準にしています。

---

## 1. フォルダ構成を準備する

`src/features/[domain]/` に必要なディレクトリとファイルを用意します。例として `sample` ドメインの構成を示します。

```text
src/features/sample
├── components
│   ├── AdminSampleCreate/
│   ├── AdminSampleEdit/
│   ├── AdminSampleList/
│   └── common/
├── entities
│   ├── drizzle.ts
│   ├── form.ts
│   ├── index.ts
│   ├── model.ts
│   └── schema.ts
├── hooks
│   ├── useCreateSample.ts
│   ├── useDeleteSample.ts
│   ├── useSampleList.ts
│   └── useUpdateSample.ts
└── services
    ├── client/
    └── server/
        ├── drizzleBase.ts
        └── sampleService.ts
```

Firestore を使う場合は `entities/firestore.ts` や `services/server/firestoreBase.ts` を追加します。`src/features/_template/` も参考にしてください。

---

## 2. `entities/` 配下

- **`drizzle.ts`** – Drizzle 用のテーブル定義。リレーションがある場合は `.references(() => otherTable.id, { onDelete: "cascade" })` などを設定します。
- **`model.ts`** – アプリ側で扱うドメインモデル型。
- **`schema.ts`** – Zod で作成・更新のバリデーションスキーマを定義。
- **`form.ts`** – フォームで扱う型を `z.infer` で定義。追加項目があれば拡張します。
- **`index.ts`** – 上記のエクスポートをまとめる。

Firestore ドメインでは `firestore.ts` にコレクションの型やコンバータを記述します。

---

## 3. サーバーサービス

`services/server/` には以下を用意します。

- **`drizzleBase.ts`** – `createCrudService()` で共通 CRUD を作成。`idType` や `defaultOrderBy` などを指定します。
- **`[domain]Service.ts`** – `base` を組み合わせてエクスポート。独自処理が必要なら `wrappers/` フォルダに分けます。
- Firestore の場合は `firestoreBase.ts` を作り、`createFirestoreCrudService()`（`services/server/firestoreBase.ts` を参照）を利用します。

---

## 4. クライアントサービス

`services/client/[domain]Client.ts` を作成し、`createApiClient("/api/[domain]")` を呼び出します。必要に応じて `ApiClient<Domain, CreateFields, UpdateFields>` の型パラメータを指定します。

---

## 5. フック

`hooks/` には CRUD 用のフックを実装します。基本は `src/lib/crud/hooks` 配下のラッパーを使います。

- `use[Domain]s` – 一覧取得（`useDomainList`）
- `use[Domain]` – 単一取得（`useDomain`）
- `useCreate[Domain]` – 作成
- `useUpdate[Domain]` – 更新
- `useDelete[Domain]` – 削除
- 必要であれば `useSearchDomain`、`useBulkDeleteByIdsDomain`、`useBulkDeleteByQueryDomain` なども追加します。

---

## 6. UI コンポーネント

`components/` には管理画面向けのセクションを配置します。

- `Admin[Domain]List/`
- `Admin[Domain]Create/`
- `Admin[Domain]Edit/`
- `common/` – フォームや共通パーツ

各フォルダの `index.tsx` で主要コンポーネントをエクスポートする形にします。

---

## 7. API ルート

`src/app/api/[domain]/` 以下に共通 CRUD ルートが用意されています。新規ドメインは `serviceRegistry` に登録すれば既存のルートで利用可能です。個別の処理が必要な場合のみ専用ルートを追加してください。

---

## 8. レジストリの更新

1. `src/registry/serviceRegistry.ts` にドメインのサービスを登録します。
2. `src/registry/schemaRegistry.ts` に `drizzle.ts` のエクスポートを追加します（Drizzle を利用する場合）。
3. 管理画面のメニューに載せる場合は `src/registry/adminDataMenu.ts` に項目を追加します。

これらに追加しておかないと API やマイグレーション、管理画面で認識されません。

---

## 9. 管理画面ページ

`src/app/admin/(protected)/` 以下に一覧・作成・編集ページを追加します。`src/app/admin/_template/` 以下の雛形をコピーするとスムーズです。`admin-global-menu.config.ts` から参照されるメニュー項目も忘れずに更新してください。
