# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨å‰Šé™¤ã®è¨­è¨ˆæ–¹é‡

## ğŸ¯ åŸºæœ¬ç†å¿µ

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã¯ **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** ã§ä¸€å…ƒç®¡ç†ã—ã€ãƒ“ã‚¸ãƒã‚¹ä¸Šã®æ„å›³ã‚’æ˜ç¢ºã«è¡¨ç¾ã™ã‚‹ã€‚
- å‰Šé™¤ã¯ **ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆè«–ç†å‰Šé™¤ï¼‰** ã¨ **ç‰©ç†å‰Šé™¤ï¼ˆå®Œå…¨å‰Šé™¤ï¼‰** ã®2æ®µéšãƒ•ãƒ­ãƒ¼ã§å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
- ç®¡ç†è€…ã«ã‚ˆã‚‹æ“ä½œã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ **æ“ä½œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«** ã§è¿½è·¡å¯èƒ½ã«ã™ã‚‹ã€‚

---

## ğŸ—ƒï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ï¼ˆ7ç¨®é¡ï¼‰

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | æ—¥æœ¬èª | èª¬æ˜ | ãƒ­ã‚°ã‚¤ãƒ³ |
|-----------|--------|------|---------|
| `pending` | æ‰¿èªå¾…ã¡ | ä»®ç™»éŒ²çŠ¶æ…‹ã€‚ç®¡ç†è€…ã®æ‰¿èªå¾…ã¡ | âŒ |
| `active` | æœ‰åŠ¹ | é€šå¸¸åˆ©ç”¨å¯èƒ½ãªçŠ¶æ…‹ | âœ… |
| `inactive` | ä¼‘ä¼šä¸­ | ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«ã‚ˆã‚‹è‡ªä¸»çš„ãªä¸€æ™‚ä¼‘æ­¢ | âŒ |
| `suspended` | ä¸€æ™‚åœæ­¢ | ç®¡ç†è€…ã«ã‚ˆã‚‹ä¸€æ™‚çš„ãªåˆ©ç”¨åˆ¶é™ã€‚å¾©å¸°å¯èƒ½ | âŒ |
| `banned` | æ°¸ä¹…åœæ­¢ | è¦ç´„é•åç­‰ã«ã‚ˆã‚‹æ°¸ä¹…è¿½æ”¾ã€‚å¾©å¸°ä¸å¯ | âŒ |
| `security_locked` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ãƒƒã‚¯ | ä¸æ­£ãƒ­ã‚°ã‚¤ãƒ³æ¤œçŸ¥ç­‰ã€‚æœ¬äººç¢ºèªã§å¾©å¸° | âŒ |
| `withdrawn` | é€€ä¼šæ¸ˆã¿ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹é€€ä¼šç”³è«‹æ¸ˆã¿ | âŒ |

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—

```typescript
// ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨å¯èƒ½
export const USER_AVAILABLE_STATUSES = ['active'] as const;

// ç™»éŒ²æ¸ˆã¿ï¼ˆèªè¨¼å®Œäº†ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå­˜åœ¨ï¼‰
export const USER_REGISTERED_STATUSES = [
  'active',
  'inactive',
  'suspended',
  'banned',
  'security_locked',
] as const;
```

> `USER_LOGIN_DISABLED_STATUSES` ã¯ `!USER_AVAILABLE_STATUSES.includes(status)` ã§è¡¨ç¾ã§ãã‚‹ãŸã‚å®šç¾©ã—ãªã„ã€‚

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»å›³

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                     â”‚
                    â–¼                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ pending â”‚â”€â”€â”€â”€â–¶â”‚ active  â”‚â—€â”€â”€â”€â–¶â”‚ inactive  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
   æ‰¿èª           â”‚  â”‚  â”‚           ä¼‘ä¼š/å¾©å¸°            â”‚
                  â”‚  â”‚  â”‚                                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
         â–¼          â–¼           â–¼                       â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
   â”‚ suspended â”‚ â”‚ banned  â”‚ â”‚security_lockedâ”‚         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
       â”‚              â”‚            â”‚                    â”‚
       â”‚ è§£é™¤         â”‚            â”‚ è§£é™¤               â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   active â”€â”€â”€â”€â”€â–¶â”‚ withdrawn â”‚â”€â”€â”€â”€â–¶â”‚  ç‰©ç†å‰Šé™¤   â”‚
      é€€ä¼š       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               ç®¡ç†è€…ã«ã‚ˆã‚‹æ‰‹å‹•å‰Šé™¤
```

---

## ğŸ—‘ï¸ å‰Šé™¤ã®è¨­è¨ˆ

### 2æ®µéšå‰Šé™¤ãƒ•ãƒ­ãƒ¼

ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆã¨ç‰©ç†å‰Šé™¤ã‚’åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã€èª¤æ“ä½œã«ã‚ˆã‚‹å®Œå…¨å‰Šé™¤ã‚’é˜²æ­¢ã™ã‚‹ã€‚

```
[é€šå¸¸ã®ç®¡ç†ç”»é¢]
  â””â”€ deletedAt IS NULL ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
  â””â”€ æ“ä½œ: ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆï¼ˆâ†’ ç®¡ç†ç”»é¢ã‹ã‚‰éè¡¨ç¤ºã«ï¼‰

         â†“

[å®Œå…¨å‰Šé™¤å°‚ç”¨ç”»é¢]
  â””â”€ deletedAt IS NOT NULL ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
  â””â”€ æ“ä½œ: å¾©å…ƒ or ç‰©ç†å‰Šé™¤ï¼ˆâ†’ DBã‹ã‚‰å®Œå…¨æ¶ˆå»ï¼‰
```

### ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆã®ç”¨é€”

| ç”¨é€” | èª¬æ˜ |
|------|------|
| **ç®¡ç†ç”»é¢ã®ã‚¯ãƒªãƒ¼ãƒ³åŒ–** | ä¸è¦ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€è¦§ã‹ã‚‰éè¡¨ç¤ºã«ã™ã‚‹ |
| **ç‰©ç†å‰Šé™¤ã®å‰æ®µéš** | å®Œå…¨å‰Šé™¤å‰ã®ç¢ºèªãƒ»çŒ¶äºˆæœŸé–“ã¨ã—ã¦æ©Ÿèƒ½ |
| **å¾©å…ƒå¯èƒ½æ€§ã®ç¢ºä¿** | èª¤æ“ä½œæ™‚ã«ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆã‹ã‚‰å¾©å…ƒå¯èƒ½ |

### ç‰©ç†å‰Šé™¤ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

#### é‹ç”¨ãƒ»ãƒ†ã‚¹ãƒˆç³»
| ã‚±ãƒ¼ã‚¹ | å‰Šé™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚° |
|--------|--------------|
| é–‹ç™ºæ™‚ã®å‹•ä½œç¢ºèªç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ | æ©Ÿèƒ½å®Œæˆå¾Œ |
| QAãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ | ãƒªãƒªãƒ¼ã‚¹å¾Œ |
| æ±ºæ¸ˆä¼šç¤¾ã®å¯©æŸ»ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | å¯©æŸ»å®Œäº†å¾Œ |
| å–¶æ¥­ãƒ‡ãƒ¢ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ | å•†è«‡çµ‚äº†å¾Œ |
| ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°â†’æœ¬ç•ªã®èª¤ç™»éŒ² | ç™ºè¦‹æ¬¡ç¬¬ |

#### æ³•çš„è¦ä»¶ç³»
| ã‚±ãƒ¼ã‚¹ | å¯¾å¿œ |
|--------|------|
| GDPRå‰Šé™¤è¦æ±‚ | å³åº§ã«ç‰©ç†å‰Šé™¤ |
| æ³•çš„å‘½ä»¤ã«ã‚ˆã‚‹å‰Šé™¤ | å‘½ä»¤ã«å¾“ã„å‰Šé™¤ |

### users ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤é–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

```typescript
// æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¿½åŠ 
{
  // ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆæ—¥æ™‚
  deletedAt: timestamp('deleted_at'),
}
```

---

## ğŸ“‹ ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«

ç®¡ç†è€…ã«ã‚ˆã‚‹æ“ä½œã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡è¦ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²ã—ã€ç›£æŸ»è¨¼è·¡ã¨ã—ã¦ä¿æŒã™ã‚‹ã€‚

### ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

```typescript
// user_action_logs
export const userActionLogs = pgTable('user_action_logs', {
  id: varchar('id', { length: 36 }).primaryKey(),

  // å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãªã—ã€ç‰©ç†å‰Šé™¤å¾Œã‚‚IDã¯æ®‹ã‚‹ï¼‰
  targetUserId: varchar('target_user_id', { length: 36 }).notNull(),

  // æ“ä½œè€…
  actorId: varchar('actor_id', { length: 36 }),  // null = system
  actorType: varchar('actor_type', { length: 20 }).notNull(), // 'admin' | 'system' | 'user'

  // æ“ä½œç¨®åˆ¥
  actionType: varchar('action_type', { length: 50 }).notNull(),

  // å¤‰æ›´å†…å®¹ï¼ˆJSONï¼‰
  beforeValue: jsonb('before_value'),
  afterValue: jsonb('after_value'),

  // ç†ç”±ãƒ»ãƒ¡ãƒ¢
  reason: text('reason'),

  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  createdAt: timestamp('created_at').defaultNow().notNull(),
});
```

> `targetUserId` ã«å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ä»˜ã‘ãªã„ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰©ç†å‰Šé™¤å¾Œã‚‚å±¥æ­´ã‚’ä¿æŒã§ãã‚‹ã€‚

### actionType ä¸€è¦§

```typescript
export const USER_ACTION_TYPES = [
  // ç®¡ç†è€…ç”¨
  'admin_status_change',     // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
  'admin_profile_update',    // ç™»éŒ²æƒ…å ±å¤‰æ›´
  'admin_soft_delete',       // ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆ
  'admin_hard_delete',       // ç‰©ç†å‰Šé™¤

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨
  'user_register',           // æ–°è¦ç™»éŒ²
  'user_pause',              // ä¼‘ä¼šï¼ˆâ†’ inactiveï¼‰
  'user_withdraw',           // é€€ä¼šï¼ˆâ†’ withdrawnï¼‰
  'user_rejoin',             // å†å…¥ä¼šï¼ˆâ†’ activeï¼‰

  // ãã®ä»–
  'other',                   // ä¾‹å¤–çš„ã‚±ãƒ¼ã‚¹
] as const;
```

### è¨˜éŒ²å†…å®¹ã®ä¾‹

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚

```typescript
await userActionLogService.create({
  targetUserId: user.id,
  actorId: adminId,
  actorType: 'admin',
  actionType: 'admin_status_change',
  beforeValue: { status: 'active' },
  afterValue: { status: 'suspended' },
  reason: 'åˆ©ç”¨è¦ç´„é•åã®ç–‘ã„ï¼ˆèª¿æŸ»ä¸­ï¼‰',
});
```

#### ç‰©ç†å‰Šé™¤æ™‚

ç‰©ç†å‰Šé™¤æ™‚ã¯ `beforeValue` ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…¨ã¦ä¿å­˜ã—ã€ç›£æŸ»è¨¼è·¡ã¨ã—ã¦å®Œå…¨ãªè¨˜éŒ²ã‚’æ®‹ã™ã€‚

```typescript
await userActionLogService.create({
  targetUserId: user.id,
  actorId: adminId,
  actorType: 'admin',
  actionType: 'admin_hard_delete',
  beforeValue: {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…¨ã¦ä¿å­˜
    id: user.id,
    email: user.email,
    displayName: user.displayName,
    status: user.status,
    role: user.role,
    createdAt: user.createdAt,
    deletedAt: user.deletedAt,
    // ... ãã®ä»–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  },
  afterValue: null,
  reason: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å‰Šé™¤',
});

// ã“ã®å¾Œã«ç‰©ç†å‰Šé™¤ã‚’å®Ÿè¡Œ
await userService.hardDelete(user.id);
```

---

## ğŸ”„ å‰Šé™¤ãƒ•ãƒ­ãƒ¼è©³ç´°

### ãƒ¦ãƒ¼ã‚¶ãƒ¼é€€ä¼šãƒ•ãƒ­ãƒ¼

```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé€€ä¼šç”³è«‹
   â””â”€ status = 'withdrawn' ã«å¤‰æ›´
   â””â”€ user_action_logs ã«è¨˜éŒ²ï¼ˆuser_withdrawï¼‰

2. é€€ä¼šçŠ¶æ…‹
   â””â”€ ãƒ­ã‚°ã‚¤ãƒ³ä¸å¯
   â””â”€ å†å…¥ä¼šç”³è«‹ã§ active ã«å¾©å¸°å¯èƒ½

3. ç®¡ç†è€…ã«ã‚ˆã‚‹ç‰©ç†å‰Šé™¤ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
   â””â”€ beforeValue ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…¨ã¦è¨˜éŒ²
   â””â”€ user_action_logs ã«è¨˜éŒ²ï¼ˆadmin_hard_deleteï¼‰
   â””â”€ ç‰©ç†å‰Šé™¤å®Ÿè¡Œ
```

### ç®¡ç†è€…ã«ã‚ˆã‚‹ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼

```
1. ç®¡ç†è€…ãŒã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆå®Ÿè¡Œ
   â””â”€ deletedAt = ç¾åœ¨æ™‚åˆ»
   â””â”€ user_action_logs ã«è¨˜éŒ²ï¼ˆadmin_soft_deleteï¼‰

2. é€šå¸¸ã®ç®¡ç†ç”»é¢ã‹ã‚‰éè¡¨ç¤ºã«ãªã‚‹

3. å®Œå…¨å‰Šé™¤ç”»é¢ã‹ã‚‰æ“ä½œ
   â””â”€ [å¾©å…ƒ] deletedAt = null ã«æˆ»ã™
   â””â”€ [ç‰©ç†å‰Šé™¤] beforeValue ã«æƒ…å ±ä¿å­˜ â†’ ç‰©ç†å‰Šé™¤
```

---

## ğŸ–¥ï¸ ç®¡ç†ç”»é¢æ§‹æˆ

```
ğŸ“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
â”œâ”€â”€ ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§        â† deletedAt IS NULL ã®ã¿è¡¨ç¤º
â”œâ”€â”€ ğŸ” æ¤œç´¢               â† deletedAt IS NULL ã®ã¿å¯¾è±¡
â”œâ”€â”€ â³ æ‰¿èªå¾…ã¡            â† status = 'pending'
â”œâ”€â”€ ğŸš« åœæ­¢ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼      â† status IN ('suspended', 'banned')
â”œâ”€â”€ ğŸ—‘ï¸ å‰Šé™¤æ¸ˆã¿            â† deletedAt IS NOT NULL
â”‚   â”œâ”€â”€ [å¾©å…ƒ] ãƒœã‚¿ãƒ³
â”‚   â””â”€â”€ [å®Œå…¨å‰Šé™¤] ãƒœã‚¿ãƒ³
â””â”€â”€ ğŸ“‹ æ“ä½œå±¥æ­´            â† user_action_logs ä¸€è¦§
```

---

## âœ… ã¾ã¨ã‚

- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**ï¼ˆ7ç¨®é¡ï¼‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ“ã‚¸ãƒã‚¹çŠ¶æ…‹ã‚’æ˜ç¢ºã«è¡¨ç¾ã™ã‚‹ã€‚
- **ã‚½ãƒ•ãƒˆãƒ‡ãƒªãƒ¼ãƒˆ** â†’ **ç‰©ç†å‰Šé™¤** ã®2æ®µéšãƒ•ãƒ­ãƒ¼ã§å®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
- **æ“ä½œå±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«** ã§ç®¡ç†è€…æ“ä½œãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‡è¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½è·¡å¯èƒ½ã«ã™ã‚‹ã€‚
- ç‰©ç†å‰Šé™¤æ™‚ã¯ `beforeValue` ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å…¨ã¦ä¿å­˜ã—ã€ç›£æŸ»è¨¼è·¡ã‚’å®Œå…¨ã«æ®‹ã™ã€‚
