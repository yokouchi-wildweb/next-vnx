# ユーザー管理統合方針と実装計画

## 目的
管理者（ローカル認証）と一般ユーザー（Firebase/OAuth）を単一の `users` テーブルで管理しつつ、データベース不要の JWT セッションで共通化するためのアーキテクチャ方針と、既に導入済みの構成要素を整理する。

---

## 全体方針サマリー
1. **ドメイン統合**：新たに `adminAuth` ドメインは設けず、既存の `auth` / `user` ドメイン内にローカル認証と Firebase/OAuth の処理を集約する。
2. **JWT セッション運用**：サインアップ・ログイン完了時に署名付き JWT を発行し、HttpOnly/Secure Cookie で保持する。トークンの無効化はログアウト時の Cookie 破棄、もしくはトークン失効時間の経過に委ねるが、利用中はローリングセッションで期限を延長する。
3. **ユーザーデータの一元取得**：サーバーコンポーネントの `AuthSessionProvider` が JWT を検証してユーザー情報を React Context に載せ、ページ・レイアウト・クライアントコンポーネント・フックから同一 API で参照できるようにする。
4. **簡潔なアクセスガード**：`authGuard` を `layout.tsx` や `page.tsx` から 1〜2 行で呼び出し、許可ロールと未許可時の遷移先を指定するだけで権限制御を実現する。
5. **ログイン UI の二系統化**：管理者ログイン（ローカル認証）と一般ログイン（Firebase/OAuth）の UI は分けつつ、どちらも同じ JWT 発行フローと Context を経由してアプリ全体にユーザーデータを配信する。
6. **ローリングセッション**：ログイン API や `/api/auth/session` による再検証時に JWT を再発行し、有効期限を延長する。

---

## 個別方針詳細

### 1. ドメイン統合とエンティティ整備
- 認証系の処理は `src/features/auth`、ユーザー関連のスキーマや補助処理は `src/features/user` にまとめる。
- 新しいセッションテーブルは作成しない。`users` テーブルには既存の `role`・`providerType`・`localPassword` を維持し、JWT に必要な値は都度 `users` から読み取る。
- ローカル認証で利用する `verifyPassword` は `src/features/auth/utils/password.ts` に配置し、ハッシュ化済みパスワードと入力値を `scrypt` 等で照合するユーティリティとして共通利用する。

### 2. JWT の発行・検証ポリシー
- JWT は Access Token のみを利用し、`sub`（userId）、`role`、`status`、`isDemo`、`providerType`、`providerUid`、`displayName`、`expiresAt` などのペイロードを含める。
- 署名鍵は環境変数で管理し、`jose` ライブラリ（`SignJWT` / `jwtVerify`）を用いて `src/lib/jwt/signUserToken.ts` / `src/lib/jwt/verifyUserToken.ts` に `signUserToken`・`verifyUserToken` を実装する。ライブラリ層では汎用的な「`subject` と任意クレーム」を扱う関数として実装し、Auth ドメイン側でスキーマに基づく正規化・検証を行う。検証失敗時は `null` を返し、ログイン画面への誘導を行う。
- Cookie 名は Firebase Hosting 互換の `__session` とし、`SameSite=Lax`・`Secure`・`HttpOnly` を設定する。ログアウト時は Cookie を削除するだけでトークンが無効化される。

### 3. サインアップ・ログイン・セッション継続・ログアウト
- サインアップ完了時（仮登録／本登録共通）およびログイン完了時に `signUserToken` で JWT を生成し、レスポンスヘッダーで Cookie を設定する。
- `AuthSessionProvider` がリクエストの Cookie からトークンを読み、`verifyUserToken` に通してユーザー情報を Context へ供給する。
- セッション継続はブラウザに保存された JWT のみで担保し、トークン期限を過ぎれば自動的に未ログイン状態として扱う。
- ローリングセションの更新は Cookie を操作できる API レイヤーで行い、ログイン成功時と `/api/auth/session` 再検証時に `signUserToken` を実行して `issueSessionCookie` 経由で新しい Cookie を返却する。
- ログアウト API は Cookie を削除するレスポンスを返し、クライアント側の `AuthSessionClientProvider` が Context を初期化する。

### 4. アクセスガードとユーザーデータ提供
- `authGuard` はサーバーコンポーネントから呼び出し、許可ロール配列と未許可時の処理（`redirect` / `notFound` など）を受け取る。内部で `verifyUserToken` を利用し、`role` 判定で制御する。Cookie の更新は行わず、必要に応じてクライアント側から `/api/auth/session` を呼び出して延命する。
- `AuthSessionClientProvider` はクライアントで React Context を公開し、`useAuthSession` フックが `user`・`isAuthenticated`・`refreshSession`（必要に応じて `/api/auth/session` を再検証）を提供する。`refreshSession` 実行時にはサーバー側でトークンを再検証・再発行し、ローリングセッションとして有効期限を更新する。
- Firebase ログイン後の ID トークン送信とローカルログイン後の JWT 発行はいずれも共通のセッション発行サービスを経由し、返却するユーザー情報の型と内容を統一する。

---

## 統合済み構成の内訳
JWT 基盤・サーバー API・コンテキスト・UI を 5 つのテーマに分けて整理する。各ステップは現在のプロジェクトで稼働している構成要素を示す。

### JWT ユーティリティと基盤整備
- `jose` を採用した署名・検証機構と共通エラー処理を整え、以降の層が利用できる土台を提供する。

| 対象 | 役割・存在意義 |
| --- | --- |
| `src/lib/jwt/constants.ts` | セッション Cookie 名やデフォルト有効期限など、JWT ユーティリティ全体で共有する定数を集約する。 |
| `src/lib/jwt/form.ts` | `signUserToken`・`verifyUserToken` 関連で利用するペイロード・クレームの型定義をジェネリクスで提供し、ドメイン固有のユーザー型を注入可能にする。 |
| `src/lib/jwt/secret.ts` | `AUTH_JWT_SECRET` を読み出し、未設定時は明示的なエラーにするためのヘルパーを提供する。 |
| `src/lib/jwt/signUserToken.ts` | `SignJWT` を利用して subject と任意クレームから署名付き JWT を生成する関数を公開する。 |
| `src/lib/jwt/verifyUserToken.ts` | `jwtVerify` で署名検証と失効チェックを行い、ドメイン側から渡されるパーサーでクレームを組み立てる汎用関数を提供する。 |
| `src/lib/jwt/parseSessionCookie.ts` | Cookie 文字列や `RequestCookies` からセッショントークン値を安全に取り出す処理を担う。 |
| `src/lib/jwt/index.ts` | JWT ユーティリティ群をまとめて再エクスポートし、利用側の import を簡潔にする。 |
| `src/features/auth/utils/password.ts` | `hashPassword`・`verifyPassword` を Auth ドメイン配下へ集約し、ローカル認証から再利用しやすくする。 |
| `src/features/auth/entities/session.ts` | JWT 生成で必須となる `role`・`providerType`・`displayName` などの属性を含むセッションユーザーとトークンペイロードのスキーマを定義する。 |
| `.env.example`（環境変数定義） | JWT 署名鍵（例：`AUTH_JWT_SECRET`）の設定項目を追加し、ローカル／本番で値を指定できるようにする。 |
| `package.json` | `jose` を依存関係へ追加し、サイン／検証処理をライブラリベースで実装できるようにする。 |

### サーバーサービスと API ルート
- ログイン・サインアップ・ログアウトを JWT ベースで統合し、Cookie への書き込みを完結させる。

| 対象 | 役割・存在意義 |
| --- | --- |
| `src/features/auth/services/server/localLogin.ts` | 管理者ユーザーを `users` から取得し、`verifyPassword` で照合後に JWT を発行・Cookie へ設定する。 |
| `src/features/auth/services/server/firebaseSession.ts` | Firebase ID トークンを検証し、既存ユーザーを特定して JWT を発行するロジックを統合する。 |
| `src/features/auth/constants/session.ts` | セッション Cookie のベース設定を共通化し、発行・削除処理から参照できるようにする。 |
| `src/features/auth/services/server/session/issueSessionCookie.ts` | `ResponseCookies` を受け取り、JWT を HttpOnly Cookie として書き込む処理を担う。ローリングセッションでの再発行にも利用する。 |
| `src/features/auth/services/server/session/clearSessionCookie.ts` | セッションクッキーの削除と失効設定をまとめ、ログアウト時に再利用できる形で保持する。 |
| `src/app/api/auth/local/login/route.ts` | ローカルログイン API を JWT 発行フローへ統合し、成功時にユーザー情報を返却する。 |
| `src/app/api/auth/firebase/login/route.ts` | Firebase 認証完了後の JWT 発行 API を整備し、共通レスポンスを返す。 |
| `src/app/api/auth/logout/route.ts` | Cookie の削除とクライアントへの成功レスポンスのみで完結する構成にする。 |
| `src/app/api/auth/session/route.ts` | Cookie 内の JWT を検証してユーザー情報を返す API。検証成功時は `issueSessionCookie` で新しいトークンを再発行し、クライアント再検証や `refreshSession` 実行時にローリングセッションを成立させる。 |

### プロバイダーとアクセスガード
- アプリ全体へユーザー情報を提供し、ページ単位の権限制御を可能にする。

| 対象 | 役割・存在意義 |
| --- | --- |
| `src/features/auth/components/AuthSessionProvider.tsx` | サーバーコンポーネントとして JWT を検証し、Context の初期値を整形して子要素へ渡す。Cookie の書き換えは行わない。 |
| `src/features/auth/components/AuthSessionContext.ts` | サーバーで検証済みのユーザー情報と `refreshSession` をまとめた Context を定義し、クライアント側から統一的に参照できるようにする。 |
| `src/features/auth/components/AuthSessionClientProvider.tsx` | `"use client"` ラッパーとして Context を公開し、クライアント側でユーザー情報を購読できるようにする。ナビゲーション後も最新のトークンを受け取れるようにする。 |
| `src/features/auth/hooks/useAuthSession.ts` | Context からユーザー情報と `refreshSession` を提供するフック。`refreshSession` は `/api/auth/session` を叩いてトークン再発行を促す。 |
| `src/features/auth/services/server/session/token.ts` | JWT クレームをセッションユーザーへ変換する共通処理をまとめる。 |
| `src/features/auth/services/server/authorization.ts` | `authGuard` を実装し、許可ロール・リダイレクト先などを受け取って簡潔に権限制御を行えるようにする。Cookie の再発行は行わない。 |
| `src/app/layout.tsx` および `/app/**/layout.tsx` | `AuthSessionProvider` を組み込み、必要なルートで `authGuard` を呼び出す構成にする。 |

### 管理者ログイン UI の統合
- 管理者向けのログイン体験を JWT 基盤へ接続し、ローカル認証完了後にセッション再取得やローリングセッション更新まで成立させる。ステップ 4 時点で管理者ユーザーのセッション管理（ログイン・セッション継続・リフレッシュ）が揃う。

| 対象 | 役割・存在意義 |
| --- | --- |
| `src/app/login/admin/page.tsx` | 管理者ログインページを JWT フローに対応させ、ログイン成功後のリダイレクトとセッション再読み込みを行う。 |
| `src/features/auth/components/AdminLogin/index.tsx` | ローカル認証フォームから `localLogin` サービスを呼び出し、成功時に `useAuthSession().refreshSession()` を実行する。 |
| `src/features/auth/services/client/localLogin.ts` | ローカルログイン API を呼び出し、`HttpError` 変換とレスポンスの型を JWT 前提に更新する。 |
| `src/features/auth/services/client/session.ts` | `/api/auth/session` を呼び出して Context を再取得し、ログイン直後や管理画面遷移時のローリングセッションを成立させる。管理者 UI の `refreshSession` から利用する。 |
| `src/features/auth/services/client/logout.ts` | `/api/auth/logout` を呼び出し、Cookie 削除をトリガーする。`normalizeHttpError` を通して `HttpError` を統一的に返却し、ログアウト後の再ログイン導線をシンプルにする。 |
| `src/features/auth/hooks/useLogout.ts` | クライアントサービスの `logout` を呼び出すフック。UI からワンアクションでログアウト実行・セッション再初期化処理（`useAuthSession().refreshSession()` など）を組み合わせられるようにする。 |

### 一般ユーザー UI と既存フローの統合
- Firebase/OAuth を含む一般ユーザー向けの UI とサインアップフローを JWT 基盤へ接続し、管理者と同様のローリングセッション体験を提供する。

| 対象 | 役割・存在意義 |
| --- | --- |
| `src/app/(user)/login/page.tsx` | 一般ユーザー向けログインページで Firebase/OAuth の結果を JWT 発行 API へ送信する処理を担う。 |
| `src/app/(user)/logout/page.tsx` | 簡易的なログアウト画面を設け、明示的なログアウト操作を提供する。 |
| `src/app/(user)/(protected)/layout.tsx` | ログイン済みのユーザーのみを許可するガードを実装し、`admin`・`user` 両ロールを許容する。 |
| `src/app/(user)/(protected)/test/page.tsx` | ログインガードの疎通確認用ページとして「メンバー専用」表示を行う。 |
| `src/features/auth/components/UserLogin/index.tsx` | Firebase ログイン UI を整理し、成功後にセッションを更新する（リダイレクト方式）。 |
| `src/features/auth/services/client/firebaseSession.ts` | Firebase ID トークンを送信して JWT を取得する処理を担う。 |
| `src/features/auth/services/server/preRegistration.ts` | 仮登録完了時に JWT を発行し、セッションクッキーを設定したうえでユーザー情報を返す。 |
| `src/features/auth/services/server/registration.ts` | 本登録完了時に JWT を発行して Cookie を更新し、レスポンスへユーザー情報を含める。 |
| `src/app/api/auth/pre-register/route.ts` | 仮登録 API が JWT を発行して Cookie を返却できるようにサーバーサービス連携を担う。 |
| `src/app/api/auth/register/route.ts` | 本登録 API で JWT を発行し、Cookie 設定とユーザー情報レスポンスを行う。 |

---

## 運用上の留意点
- JWT 基盤 → API → プロバイダー／ガード → UI・既存フローという構成順序で依存関係が組まれている。変更時もこの依存順を意識して影響範囲を評価する。
- トークン失効はブラウザ内の Cookie 削除と期限切れで完結するため、DB を使った強制失効は行わない。必要に応じてトークン有効期間を短めに設定する。
- 管理者・一般ユーザーの区別は JWT ペイロードに含まれる `role` と `providerType` を用いて行い、アプリ全体で同じコンテキストとガードロジックを共有する。
