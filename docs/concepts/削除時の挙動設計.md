# 削除時の挙動設計

## 概要

外部キー制約における削除時の挙動（onDelete）を設定可能にする設計。

## 選択可能な挙動

| 挙動 | 説明 | Drizzle設定 |
|------|------|-------------|
| CASCADE | 参照先削除時に、このレコードも削除 | `onDelete: "cascade"` |
| RESTRICT | 参照先が削除されようとしたら拒否 | `onDelete: "restrict"` |
| SET_NULL | 参照先削除時に、外部キーをNULLに設定 | `onDelete: "set null"` |

## リレーションタイプ別の適用

| リレーションタイプ | onDelete設定 | 理由 |
|------------------|-------------|------|
| belongsTo | ✅ 選択可能 | 外部キーがこのテーブルにある |
| hasOne | ❌ 設定不要 | 外部キーは相手テーブル |
| hasMany | ❌ 設定不要 | 外部キーは相手テーブル |
| belongsToMany | CASCADE固定 | 中間テーブルの関連削除 |

## required との制約

| onDelete | required: true | required: false |
|----------|---------------|-----------------|
| CASCADE | ✅ 有効 | ✅ 有効 |
| RESTRICT | ✅ 有効 | ✅ 有効 |
| SET_NULL | ❌ 矛盾（エラー） | ✅ 有効 |

**理由**: SET_NULL は削除時にNULLを設定するため、NOT NULL制約（required: true）と矛盾する。

## domain.json の設定例

```json
{
  "relations": [
    {
      "domain": "sample_category",
      "fieldName": "sample_category_id",
      "relationType": "belongsTo",
      "required": false,
      "onDelete": "SET_NULL"
    }
  ]
}
```

## 後方互換性

| 設定状況 | 適用される挙動 |
|---------|--------------|
| `onDelete` あり | 設定値を使用 |
| `onDeleteCascade: true` | CASCADE（旧形式） |
| `onDeleteCascade: false` | RESTRICT（旧形式） |
| どちらも存在しない | RESTRICT（デフォルト） |

**デフォルト: RESTRICT** を採用する理由:
- 意図しないデータ削除を防ぐ（安全性）
- PostgreSQL のデフォルトと一致
- 明示的に選択すべき挙動（CASCADE/SET_NULL）との区別

## トランザクション時の挙動

RESTRICTで参照があり削除が拒否された場合、トランザクション全体がロールバックされる。

## 変更履歴

- 2024-XX-XX: 初版作成（onDeleteCascade → onDelete への移行）
