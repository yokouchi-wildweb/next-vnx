# ユーザー登録・認証の新方針

## 🎯 基本理念
- すべての登録プロバイダーは **独立したユーザーアカウント** を生成し、メールアドレスや氏名が一致していてもマージしない。
- プロバイダーごとにデータモデルの責務を分離し、重複チェック、アカウント発行、状態遷移を明示する。
- 監査や運用で利用者の識別が必要な場合は、プロバイダー種別 + プロバイダー内識別子を鍵として扱う。

この前提により、「同一人物が複数の経路で登録した場合でも、それぞれ独立した利用者」として扱える。

---

## 🗃️ データモデル

### `users`
各登録プロバイダーで作成されたユーザーアカウントを 1 行で表現するテーブル。プロバイダーの種類を問わず共通のスキーマを用いる。

#### スキーマ設計の方針
- **User ドメイン** ではコアフィールドのみを必須とした「ベーススキーマ」を 1 つ用意し、それ以外の項目は原則オプショナルとして扱う。
- ベーススキーマを拡張して「一般ユーザー用スキーマ」「管理者ユーザー用スキーマ」を定義し、合計 3 種類のスキーマを提供する。
  - 一般ユーザー用スキーマでは本登録時に必要なプロフィール項目や同意チェックなど、一般利用者向けの追加要件のみを必須化する。
  - 管理者ユーザー用スキーマでは役割や初期パスワードなど管理者固有の項目を必須化し、管理者登録フローの入力を保証する。
- 仮登録・本登録のフェーズを問わず常に同一のスキーマ群を利用し、登録経路に依存しないバリデーションを実現する。
- 認証情報の有無や有効性、パスワード再入力チェックなどは **Auth ドメインの責務** とし、User ドメインのスキーマでは取り扱わない。
- AuthドメインではUserドメインのスキーマをベースに拡張して使用する
- これにより、User ドメインは汎用的にユーザー属性を受け入れ、Auth ドメインでコンテキストに応じた厳密な検証を行う構造を維持する。

| コアフィールド | 型 | 説明 |
| --- | --- | --- |
| `id` | `uuid` (PK) | システム内の主キー。 |
| `provider_type` | enum (`email`, `local`, `google.com`, `yahoo.com`, `…`) | 登録経路。アプリでの権限判定にも使用。 |
| `provider_uid` | text | プロバイダー側の ID。`(provider_type, provider_uid)` に UNIQUE 制約を付与。`email` の場合は Firebase Auth の UID、`local` の場合はメールアドレスをそのまま設定する。 |
| `role` | enum (`admin`, `user`, `…`) | 管理者や一般ユーザーなどの権限区分。必要に応じて enum を拡張する。 |
| `email` | text NULL 可 | 本登録で確定したメールアドレス。サードパーティが提供した値もここへ保存し、未提供の場合は本登録での入力を必須にする。 |
| `local_password` | text NULL 可 | ローカル認証用のパスワード（ハッシュ化済み）。Firebase などのプロバイダー利用時は null のままとする。 |
| `status` | enum (`pending`, `active`, `inactive`, `locked`) | アカウント状態。 |
| `is_demo` | boolean | デモユーザーフラグ。デモモード時はDB書き込みをスキップする。 |
| `last_authenticated_at` | timestamptz NULL 可 | 最終認証日時。 |
| `created_at` / `updated_at` | timestamptz | 監査用タイムスタンプ。 |
| `display_name` | text NULL 可 | 表示名。現状はこの 1 項目のみがユーザー自身で更新可能。 |

| ミュータブルフィールド | 型 | 説明 |
| --- | --- | --- |
| `avatar_url` *(候補)* | text NULL 可 | 今後追加する場合を想定したプロフィール画像 URL。 |
| `self_introduction` *(候補)* | text NULL 可 | 自己紹介などの自由記述欄。 |

`provider_type` の想定値と意味合い:

- `local` … 管理画面など、Firebase に依存しない独自フォームで管理者が作成するアカウント。アプリ内での管理者権限発行に使用する。
- `email` … Firebase Email Link など、メールアドレスを ID として扱う標準的なユーザー登録経路。メールリンクでサインインが完了
  した時点で Firebase Auth が発行する UID を取得し、これを `provider_uid` として保存する。
- `google.com` / `yahoo.com` / `facebook.com` / `twitter.com` / その他サードパーティ … OAuth など外部プロバイダーを利用した登録。取得した一意 ID を `provider_uid` に保持する。

> Firebase Authentication 由来の `providerId` をそのまま `provider_type` に採用している。`google.com` や `yahoo.com` といった値は Firebase SDK の戻り値と一致するため、クライアント/サーバー間で追加のマッピングなしに扱える。

`role` はアプリ側の権限制御を担い、`provider_type` とは独立して「管理者」「一般ユーザー」などの属性を区別する。将来的に監査専用など追加が必要になれば enum を拡張する。

- `pending` … メール・サードパーティ認証は済んだが本登録が終わっていない状態。再度登録処理をやり直しても初回と同様に処理できる。
- `active` … 通常利用が可能な状態。プロフィール確定や管理者による本登録が完了している。
- `inactive` … 長期未利用によって一時的に無効化された状態。再開時は `active` に戻す。
- `locked` … 利用規約違反などにより強制停止された状態。管理者以外は変更できない。

> **ポイント**: メールアドレスが一致しても別行として管理する。

---

## 🔄 登録・認証プロセス

通常の方法でユーザーが自身で登録したアカウントはすべて `一般ユーザー（role='user'）` になる。  
管理者登録の方法は後述。

### 1. メールアドレス登録（Email Link）

| フェーズ         | 滞在 URL 例                      | 主な処理                                                                                                                              | DB 更新 | 重複チェック                                                                                                    |
|--------------|-------------------------------|-----------------------------------------------------------------------------------------------------------------------------------| --- |-----------------------------------------------------------------------------------------------------------|
| メール入力        | `GET /signup`                 | フォームで受け取ったメールアドレスを localStorage に保存。認証リンク踏み直し時に参照するため、期限切れになった場合でも上書きせず保持する。                                                      | なし。 | (provider_type="email", email=<入力されたアドレス>)で重複チェックを行い本登録済みなら処理を中止してメッセージを表示。                               |
| 送信完了画面       | `GET /signup/mail-sent`       | メール送信完了を案内。リンク再送の導線としてサインアップページへのリンクを表示。                                                                                          | なし。 | -                                                                                                         |
| 認証メール送信      | `POST /api/auth/email/send`   | Firebase などでメールリンクを送信。`continueUrl` は `/signup/verify` に設定する。                                                                     | なし。 | -                                                                                                         |
| リンク検証        | `GET /signup/verify?...`      | リンクを開いた端末に依存せず処理を続行できる状態に整える。`checkActionCode(auth, oobCode)` で期限切れのチェック(期限切れなら処理中止）、その後 localStorage からEmailの取得、取得不可能な場合は手動でアドレス入力フォームの表示 | なし。 | -                                                                                                         |
| サインインの実行     |                               | リンクが有効でEmailなどを取得できたら、`signInWithEmailLink()` を使用してサインインを実行し、結果を判定する。                                                             | なし。 | -                                                                                                         
| 仮登録 API     | `POST /api/auth/pre-register` | 検証済みのトークンとメールアドレスを受け取りサーバー側で仮登録処理を実施。DB登録前に重複チェックを行う。その後 Firebase UID を `provider_uid` として確定。                                            | `(provider_type='email', provider_uid=<FirebaseのUID>)` で UPSERT し、`status='pending'` を設定。`email` カラムには認証で確定したメールアドレスを保存する。<br/>リクエスト元の IP アドレスや User-Agent は監査ログなど別ストアで扱い、`users` には保持しない。 | 既存レコードの status が `active` や `inactive` などの場合は本登録済みの旨を通知し、サインアウトしてログイン画面へのリンクを表示。`locked` など問題がある場合は処理を中止。 |
| 本登録フォーム      | `GET /signup/register`        | `email` は認証済みアドレスを編集不可で表示。パスワードの設定は必須。その他、追加のプロフィール情報を入力させることも可能。                                                                 | なし。 | -                                                                                                         |
| 本登録 API | `POST /api/auth/register`     | 入力内容を確定。Firebase Auth のパスワード設定を完了させ `status` を `active` に更新、その他情報の保存が完了したら完了画面へ遷移。                                                | `status='active'`、その他任意の項目も保存。`local_password` は null のままとし、`last_authenticated_at` も更新。 | 重複レコードで `active`、`inactive`、`locked` など本登録済みがあれば処理を中止。                                                    |
| 完了画面         | `GET /signup/complete`        | 完了メッセージを表示し、ダッシュボードなどへの遷移導線を用意。                                                                                                   | なし。 | -                                                                                                         |
> 本登録が完了しない限り何度でも上書きで再登録が可能なので `仮登録 API` の時点では `UPSERT` を実施


#### 認証メールリンククリック後のフローの補足

1. **URL の妥当性チェック**
   - `continueUrl` で遷移した `/signup/verify` で、URL に埋め込まれたパラメーターが欠損している、もしくは Firebase などの検証で期限切れと判定された場合は即座にエラー画面を表示する。
   - `checkActionCode(auth, oobCode)` を使用すればメールアドレス未取得状態でも先行して期限切れのチェックが可能。
   - エラー画面では「リンクが無効または期限切れ」である旨を通知し、`/signup` へ戻る導線（ボタンやリンク）を提示する。

2. **localStorage から送付先メールアドレスを取得**
   - 認証リンクを開いたブラウザの `localStorage` にメールアドレスが存在すればフォームを経由せずに `POST /api/auth/pre-register` をコールし、即時に認証を完了させる。
   - 取得できなかった場合（別端末でリンクを開いたケースなど）は、メールアドレス単一項目のフォームを表示する。送信時に入力値を `email` として `POST /api/auth/pre-register` に渡し、送信前後で入力値を再度 `localStorage` に保存する。Firebase から受け取った UID はサーバー側で `provider_uid` に反映する。

3. **既存ユーザーの検出**
   - クライアントでは Firebase へのサインイン結果を受け取ったら即座に `/api/auth/pre-register` を呼び出す。
   - サーバー側で `(provider_type='email', provider_uid=<Firebase の UID>)` をキーに UPSERT し、`status` が `active` や `inactive` など本登録済みの場合はログイン済みとして扱う。
   - 本登録済みユーザーだった場合はクライアントでサインアウトし、「登録済みユーザー向け案内」画面からログインページへの導線を提示する。

4. **認証結果のハンドリング**
   - API がエラーを返した場合は可能な範囲で理由（例: トークン期限切れ、メール不一致など）を表示して処理を終了する。必要に応じて `/signup` へのリンクを併記する。
   - 仮登録が成功した場合は本登録画面（`/signup/register`）へ遷移する。以降は本登録フォームのフローに従う。

---

### 2. OAuth（Google / Yahoo! など）

| フェーズ          | 滞在 URL 例                      | 主な処理                                                                                                           | DB 更新 | 重複チェック |
|---------------|-------------------------------|----------------------------------------------------------------------------------------------------------------| --- | --- |
| プロバイダー選択      | `GET /signup`                 | サインアップ開始画面はEmail認証と共通。「Google で登録」などのボタンを表示。選択されたプロバイダー情報を保持しつつ `/signup/oauth` へ遷移する。                         | なし。 | - |
| OAuth中継（認証開始） | `GET /signup/oauth`           | プロバイダー種別を受け取り、CSRF 対策や Firebase の初期化などを実施。準備が整ったら `signInWithRedirect(provider)` を実行してプロバイダー画面へリダイレクトする。       | なし。 | - |
| プロバイダー同意      | OAuth プロバイダー側画面               | 同意フローを完了し、ID、トークン、メールアドレスなどを Firebase 経由で取得。`continueUrl=/signup/oauth` でクライアントへ復帰する。                          | なし。 | - |
| OAuth中継（認証後）  | `GET /signup/oauth`           | `getRedirectResult()` などで `userCredential` を取得し、必要な情報を抽出。Firebase トークンの検証やプロバイダー識別子の確定を行い、仮登録 API 呼び出しの準備を整える。 | なし。 | - |
| 仮登録 API       | `POST /api/auth/pre-register` | プロバイダーから得たトークン・UID・メールアドレスなどを送信し、ユーザーを仮登録。                                                                     | `(provider_type='google.com' など, provider_uid=<プロバイダーの UID>)` で UPSERT し、`status='pending'` を設定。メールアドレスがあれば `email` に保存。 | `(provider_type, provider_uid)` のユニーク制約で重複が発生した場合、`status='pending'` なら継続。`active` など本登録済みならログイン扱いでトップページへ。 |
| 本登録フォーム       | `GET /signup/register`        | Email の入力は必須（取得済みなら初期表示）。パスワードは使用せず、その他プロフィール項目を必要に応じて表示する。                                                    | なし。 | - |
| 本登録 API       | `POST /api/auth/register`     | 入力内容を確定し `status='active'` へ遷移。`provider_uid` には OAuth の一意 ID を保持する。                                           | `status='active'` へ更新し、`email` もここで確定。 | `(provider_type, provider_uid)` のユニーク制約で競合したらエラー。 |
| 完了画面          | `GET /signup/complete`        | 完了メッセージとダッシュボードへの導線を表示。                                                                                        | 任意で `last_authenticated_at` を更新。 | - |

> 本登録が完了しない限り何度でも上書きで再登録が可能なので `仮登録 API` の時点では `UPSERT` を実施

> すでに本登録済みで再認証した場合は、自動でログインを完了しトップページなどへ遷移

- Firebase から受け取った `userCredential.user.getIdToken()` の結果をサーバーへ送信し、`verifyIdToken()` でトークンを検証してから `/api/auth/pre-register` の処理を進める。`/signup/oauth` はこの準備とバリデーションを担う。

メール登録・OAuth いずれの場合も仮登録 API は `/api/auth/pre-register` に統一し、`(provider_type='xxx', provider_uid=<Firebase の UID など>)` で UPSERT する。`provider_type` や `provider_uid` の値は経路ごとに異なるが、保存方針と重複チェックのキーは共通となる。

Auth ドメインではサインアップフォーム入力時やサーバー側で User ドメインの登録サービスを呼び出す直前に、前述のベーススキーマを拡張したスキーマを適用する。これにより、Auth ドメイン固有の要件（認証情報の検証、パスワード確認欄の整合性チェックなど）を追加しつつ、User ドメインとスキーマ定義を共有できる。

### 3. 管理画面からのユーザー登録（管理者・一般）

管理画面のユーザー追加フォームから、管理者および一般ユーザーも追加が可能。
重複チェックは送信時に `provider_type` と `provider_uid` の組み合わせで行い、既存レコードがあればエラーとして扱う。

1. **フォーム入力と共通処理**
   - メールアドレスと初期パスワード（確認欄を含む）を入力する。
   - 保存時に `users` テーブルへ `status='active'` で即時登録し、`last_authenticated_at` はログイン後に更新される。

2. **管理者を追加する場合**
   - `role='admin'`, `provider_type='local'` を設定する。
- 認証は Firebase に依存せず、アプリ側でハッシュ化したパスワードを `local_password` として保存する。
- メール認証などの追加フローは不要で、フォーム送信と同時に有効なアカウントとなる。

3. **一般ユーザーを追加する場合**
   - `role='user'`, `provider_type='email'` を設定する。
   - 内部的には Firebase の email プロバイダー API を使用してユーザーを作成し、`provider_uid` や必要な識別子を取得してから DB に登録する。
   - 管理者経由で作成されたユーザーもメール認証は不要で、フォーム送信直後に有効化された状態になる。

> 管理者と一般で `provider_type` が異なるため別プロバイダ扱いである点に注意

---

## 📝 本登録フォーム

メール認証、サードパーティ認証、いずれの場合も仮登録完了後に本登録フォームを表示するが入力項目が異なる。

|             | メール認証            | サードパーティ認証                    |
|-------------|------------------|------------------------------|
| メールアドレス     | 認証済みアドレスを編集不可で表示 | 入力必須。<br/>初期表示はプロバイダー提供の情報由来 |
| パスワード & 再確認 | 入力必須             | 使用しないため項目なし                  |
| その他プロフィール項目 | 任意で追加            | 任意で追加                        |

- メール認証の場合は前プロセスで認証したアドレスを表示するが、ここでの修正は不可とする。
- サードパーティ認証の場合は前プロセスで保存したプロバイダ提供のアドレスを編集可能で初期表示する（未提供の場合は空欄になる）。送信時に `email` へ改めて保存し、同じ値を `provider_uid` にはコピーしない（`provider_uid` はプロバイダーから得た ID を保持する）。
- メール認証では本登録フォーム送信時点で Firebase Auth のパスワードを確定させるが、`local_password` は保持しない。管理画面登録は本登録フォームを経由せず、管理者が入力したパスワードをFirebase側に登録する。
- サードパーティ認証ではパスワード自体を使用しないので項目を表示しない。
- 管理画面からの管理者アカウント発行の場合本登録画面は存在しない


---

## ✅ まとめ
- 同一メールアドレスであってもプロバイダー単位で完全に独立したアカウントとして扱う。
- `users` テーブルを中心に、登録プロセスごとの重複チェックタイミングと状態遷移を明記した。
- メール登録・管理画面経由の登録・OAuth それぞれの流れで、送信/保存前に行うべき検証ポイントを定義した。
