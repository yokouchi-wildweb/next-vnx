# ゲームアーキテクチャ概要

## 全体構成

ゲームエンジンは階層構造で設計されている。上位レイヤーが下位レイヤーを制御する。

```
GameManager（ゲーム全体）
  └─ ScenarioManager（シナリオ単位）
       └─ SceneController（シーン単位）
            ├─ Composer（UI配置）
            └─ Executor（進行制御）
                 └─ Features（表示・状態）
```

---

## 各コンポーネントの役割

### GameManager

ゲーム全体を管理する最上位のコンポーネント。

- セーブ/ロード機能
- タイトル画面 ↔ ゲーム本編の切り替え
- ゲーム全体で1つのみ存在

### ScenarioManager

シナリオ（複数シーンのまとまり）を管理する。

- 現在どのシーンにいるかを追跡
- シーン間の遷移（church → school など）
- 分岐管理
- Executor から「シーン終了」通知を受け取り、次のシーンを決定

### SceneController

個別シーンの初期化と調整を担当する。全シーンタイプで共通のコントローラー。

**処理の流れ**:
1. `scene.json` を読み込む
2. `type` から Archetype を取得（SceneArchetypeRegistry 経由）
3. Archetype の arrangement と scene.json の overrides をマージ
4. Feature の Store に初期データをセット
5. Composer を選択（カスタムがあればそれを、なければ自動生成）
6. Executor を起動

### Composer（SceneComposer）

Feature の Widget/Sprite を画面に配置する。

- **AutoComposer**: arrangement 情報から自動生成（シンプルなシーン用）
- **カスタム Composer**: 手書きで配置を制御（複雑なシーン用）

Archetype に `composer` が指定されていればそれを使い、なければ AutoComposer で自動生成する。

### Executor

シーン内の進行を制御する。シーンタイプごとに異なる Executor を使用。

| シーンタイプ | Executor | 役割 |
|-------------|----------|------|
| chat, novel | DialogueExecutor | dialogues を順番に処理 |
| exploration | ExplorationExecutor | マップ移動、アイテム取得 |
| battle | BattleExecutor | ターン制バトル処理 |

**処理の流れ**:
1. 進行データ（dialogues など）を受け取る
2. ユーザー入力を待つ
3. Feature の Store を更新（次のメッセージ、話者変更など）
4. commands を処理（BGM変更、SE再生など）
5. シーン終了時に ScenarioManager へ通知

---

## Feature（機能単位モジュール）

Feature は「状態 + UI + API」をバンドルしたモジュール。

```typescript
const Dialogue = {
  // PixiJS コンポーネント（Canvas内）
  Sprites: {
    Characters: DialogueCharactersSprite,
  },

  // HTML コンポーネント（DOM）
  Layers: {
    UI: DialogueUILayer,
  },

  // 状態アクセス
  hooks: {
    useDialogue(),         // 状態を読む（Widget/Sprite用）
    useDialogueActions(),  // 状態を更新する（Executor用）
  },
}
```

**重要**: Feature は受動的。自分では動かず、SceneController や Executor によって駆動される。

### 主要な Feature

| Feature | 役割 |
|---------|------|
| Background | 背景画像の表示・切り替え |
| Character | 立ち絵の表示・表情切り替え |
| Dialogue | メッセージ表示・話者名表示 |
| Audio | BGM/SE の再生 |

---

## Archetype（シーンの原型）

シーンタイプごとの標準構成を定義する。

```typescript
const chatArchetype = {
  // このシーンで使う Feature
  features: ["Background", "Character", "Dialogue", "Audio"],

  // 使用する Executor
  executor: DialogueExecutor,

  // カスタム Composer（null なら自動生成）
  composer: null,

  // 配置設定（デフォルト値）
  arrangement: {
    sprites: [...],
    layers: [...],
  },
}
```

SceneArchetypeRegistry で管理され、`type` から引き出せる。

---

## データフロー

```
scene.json
    ↓ 読み込み
SceneController
    ↓ type: "chat" → Archetype 取得
    ↓ arrangement + overrides をマージ
    ↓
Feature Stores に初期データをセット
    ↓
Composer → UI を描画
    ↓
Executor → 進行ループ開始
    ↓ ユーザー操作に応じて
Feature Stores を更新
    ↓ Zustand のリアクティビティ
Feature Components が再レンダリング
```

---

## scene.json の構造

```json
{
  "type": "chat",

  "overrides": {
    "Dialogue.UI": { "bottom": "5%" }
  },

  "backgrounds": {
    "default": "church/default"
  },
  "initialBackground": "default",

  "characters": {
    "circus": { "position": "left" },
    "tatsumi": { "position": "right" }
  },

  "initialBgm": {
    "assetId": "存在しない街",
    "volume": 0.5
  },

  "dialogues": [
    { "speaker": "circus", "text": "セリフ..." },
    {
      "speaker": "tatsumi",
      "text": "セリフ...",
      "commands": [{ "type": "bgm", "assetId": "..." }]
    }
  ]
}
```

- `type`: どの Archetype を使うか
- `overrides`: 配置のカスタマイズ（Archetype のデフォルトを上書き）
- その他: シーン固有のデータ

---

## ファクトリ

Feature のコンポーネントを生成するためのファクトリ関数。

| ファクトリ | 対象 | 効果 |
|-----------|------|------|
| createWidget | HTML コンポーネント | `position: absolute` + `zIndex` を注入 |
| createSprite | PixiJS コンポーネント | displayName を付与（パススルー） |
| createLayer | Widget グループ | `absolute` + `inset: 0` + `pointerEvents: none` + `zIndex` |
| createScene | Scene コンテナ | `absolute` + `inset: 0` |

---

## バリデーション（将来実装）

開発後半で Zod によるバリデーションを導入予定。

- Archetype に schema を持たせる
- SceneController の読み込み時に検証
- シーンタイプごとに必須項目を強制

```typescript
const chatArchetype = {
  // ...
  schema: chatSceneSchema,  // Zod スキーマ
}

const chatSceneSchema = baseSceneSchema.extend({
  dialogues: z.array(...),
  characters: z.record(...),
  backgrounds: z.record(...),
})
```

---

## 命名規則

| サフィックス | 意味 |
|-------------|------|
| `*Sprite` | PixiJS コンポーネント（Canvas 内） |
| `*Layer` | Widget グループ（createLayer で生成） |
| `*Widget` | 単体の HTML コンポーネント（createWidget で生成） |
| サフィックスなし | 通常の React コンポーネント |
